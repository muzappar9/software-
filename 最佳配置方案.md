# 🏆 法律顾问App - 最佳配置方案 (2024版)

> **成功验证的配置** - 经过多次测试确定的最佳实践

## 📱 **项目概览**
- **应用名称**: 法律顾问App
- **框架**: Flutter + MediaPipe + LawPack数据库
- **AI模型**: Gemma 3 1B (量化int4) - 554MB
- **目标平台**: Android (优先)
- **构建工具**: Codemagic CI/CD

---

## 🔧 **核心版本配置**

### **Flutter & Dart**
```yaml
flutter: stable (最新稳定版)
dart: 与Flutter匹配
```

### **Android工具链 (关键配置)**
```gradle
# Android Gradle Plugin (AGP)
AGP_VERSION = "8.6.1"

# Gradle版本
GRADLE_VERSION = "8.9"

# Kotlin版本  
KOTLIN_VERSION = "2.1.0"

# NDK版本
NDK_VERSION = "26.1.10909125"

# Java版本
JAVA_VERSION = "21" (LTS)

# Android API
COMPILE_SDK = 34
TARGET_SDK = 34
MIN_SDK = 21
```

---

## 📁 **关键配置文件**

### **1. android/settings.gradle**
```gradle
pluginManagement {
    def flutterSdkPath = {
        def properties = new Properties()
        file("local.properties").withInputStream { properties.load(it) }
        def flutterSdkPath = properties.getProperty("flutter.sdk")
        assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
        return flutterSdkPath
    }()

    includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")

    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id "dev.flutter.flutter-plugin-loader" version "1.0.0"
    id "com.android.application" version "8.6.1" apply false
    id "org.jetbrains.kotlin.android" version "2.1.0" apply false
}

include ":app"
```

### **2. android/app/build.gradle**
```gradle
plugins {
    id "com.android.application"
    id "org.jetbrains.kotlin.android"
    id "dev.flutter.flutter-gradle-plugin"
}

def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader ->
        localProperties.load(reader)
    }
}

def flutterRoot = localProperties.getProperty('flutter.sdk')
if (flutterRoot == null) {
    throw new GradleException("Flutter SDK not found. Define location with flutter.sdk in the local.properties file.")
}

def flutterVersionCode = localProperties.getProperty('flutter.versionCode')
if (flutterVersionCode == null) {
    flutterVersionCode = '1'
}

def flutterVersionName = localProperties.getProperty('flutter.versionName')
if (flutterVersionName == null) {
    flutterVersionName = '1.0'
}

android {
    namespace 'com.example.legal_advisor_app'
    compileSdk 34
    ndkVersion "26.1.10909125"

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_21
        targetCompatibility JavaVersion.VERSION_21
    }

    kotlinOptions {
        jvmTarget = '21'
    }

    sourceSets {
        main.java.srcDirs += 'src/main/kotlin'
    }

    defaultConfig {
        applicationId "com.example.legal_advisor_app"
        minSdk 21
        targetSdk flutter.targetSdkVersion
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName
    }

    buildTypes {
        release {
            signingConfig signingConfigs.debug
        }
    }
}

flutter {
    source '../..'
}

dependencies {
    // MediaPipe依赖 (ARM官方推荐稳定版本)
    implementation 'com.google.mediapipe:tasks-vision:0.10.15'
    implementation 'com.google.mediapipe:tasks-text:0.10.15'
}
```

### **3. android/gradle/wrapper/gradle-wrapper.properties**
```properties
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.9-all.zip
```

### **4. android/build.gradle (根项目)**
```gradle
allprojects {
    repositories {
        maven { url 'https://maven.aliyun.com/repository/google' }
        maven { url 'https://maven.aliyun.com/repository/central' }
        maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
        google()
        mavenCentral()
    }
}

rootProject.buildDir = '../build'
subprojects {
    project.buildDir = "${rootProject.buildDir}/${project.name}"
}
subprojects {
    project.evaluationDependsOn(':app')
}

tasks.register("clean", Delete) {
    delete rootProject.buildDir
}
```

### **5. pubspec.yaml (关键依赖)**
```yaml
dependencies:
  flutter:
    sdk: flutter
  flutter_localizations:
    sdk: flutter
  
  # UI框架
  cupertino_icons: ^1.0.8
  
  # 状态管理
  flutter_riverpod: ^2.6.1
  
  # 国际化
  intl: ^0.20.2  # 必须兼容flutter_localizations
  
  # HTTP请求
  dio: ^5.7.0
  
  # 本地存储
  sqflite: ^2.4.1
  path_provider: ^2.1.4
  
  # 权限
  permission_handler: ^11.3.1

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^5.0.0

flutter:
  uses-material-design: true
  
  assets:
    - assets/
    - assets/models/
    - assets/lawpack.db
    - assets/models/gemma-3-270m.task
```

---

## 🚀 **Codemagic CI/CD配置**

### **codemagic.yaml**
```yaml
workflows:
  android-workflow:
    name: Android Build
    instance_type: mac_mini_m1
    max_build_duration: 120
    cache:
      cache_paths:
        - $HOME/.gradle/caches
        - $HOME/.android/build-cache
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        JAVA_TOOL_OPTIONS: "-Xmx8g"
    scripts:
      - name: Set up local properties
        script: |
          echo "flutter.sdk=$FLUTTER_ROOT" > "$FCI_BUILD_DIR/android/local.properties"

      - name: Install Android NDK
        script: |
          echo "Installing NDK 26.1.10909125..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "ndk;26.1.10909125" --channel=3

      - name: Setup Gradle properties for memory
        script: |
          mkdir -p $HOME/.gradle
          echo "org.gradle.jvmargs=-Xmx8g" > $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.configureondemand=true" >> $HOME/.gradle/gradle.properties

      - name: Get Flutter packages
        script: |
          flutter packages pub get

      - name: Build APK with Flutter
        script: |
          flutter build apk --release

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk

    publishing:
      email:
        recipients:
          - your_email@example.com
        notify:
          success: true
          failure: true
```

---

## 📦 **AI模型配置**

### **模型文件规格**
```
文件名: gemma-3-270m.task
格式: MediaPipe Task格式
大小: 554MB (1B参数模型，int4量化)
路径: assets/models/gemma-3-270m.task
```

### **LFS配置 (.gitattributes)**
```
# Git LFS tracking for large files
*.task filter=lfs diff=lfs merge=lfs -text
*.db filter=lfs diff=lfs merge=lfs -text
*.gguf filter=lfs diff=lfs merge=lfs -text
*.bin filter=lfs diff=lfs merge=lfs -text
*.safetensors filter=lfs diff=lfs merge=lfs -text
*.apk filter=lfs diff=lfs merge=lfs -text
*.aab filter=lfs diff=lfs merge=lfs -text
```

---

## 🗃️ **数据库配置**

### **LawPack数据库**
```
文件名: lawpack.db
大小: 1.9MB
路径: assets/lawpack.db
格式: SQLite
内容: 中国法律条文数据
```

---

## ⚠️ **关键注意事项**

### **版本兼容性矩阵**
| 组件 | 版本 | 兼容要求 |
|------|------|----------|
| Java | 21 | Gradle 8.9+ |
| Gradle | 8.9 | AGP 8.6.1+ |
| AGP | 8.6.1 | Kotlin 2.1.0+ |
| Kotlin | 2.1.0 | Java 21+ |
| NDK | 26.1.10909125 | AGP 8.6.1+ |

### **内存配置**
```bash
# Codemagic环境变量
JAVA_TOOL_OPTIONS: "-Xmx8g"

# Gradle内存配置
org.gradle.jvmargs=-Xmx8g
org.gradle.daemon=true
org.gradle.parallel=true
org.gradle.configureondemand=true
```

### **LFS预算管理**
- **限制**: GitHub免费账户1GB存储+1GB带宽/月
- **当前使用**: ~556MB (模型554MB + 数据库1.9MB)
- **建议**: 避免添加APK文件到仓库

---

## 🔄 **标准部署流程**

### **1. 项目初始化**
```bash
flutter create legal_advisor_app
cd legal_advisor_app
```

### **2. 配置文件部署**
- 按上述配置更新所有gradle文件
- 更新pubspec.yaml依赖
- 配置codemagic.yaml

### **3. 模型文件部署**
```bash
# 复制模型文件
cp gemma3-1B-it-int4.task assets/models/gemma-3-270m.task

# Git LFS配置
git lfs track "*.task"
git add .gitattributes
git add -f assets/models/gemma-3-270m.task
```

### **4. GitHub仓库设置**
```bash
git init
git remote add origin https://github.com/username/repo.git
git add .
git commit -m "Initial commit with optimized config"
git push origin main
```

### **5. Codemagic连接**
- 授权GitHub访问
- 选择仓库
- 导入codemagic.yaml配置
- 启动构建

---

## 🎯 **成功指标**

### **构建时间**
- 预期: 8-12分钟
- NDK安装: 2-3分钟
- Flutter构建: 5-8分钟

### **输出文件**
- APK大小: ~200-300MB
- 包含AI模型和数据库
- Release模式优化

---

## 🛠️ **故障排除**

### **常见问题解决**
1. **LFS配额超限**: 移除不必要大文件
2. **NDK未配置**: 确保自动安装脚本正确
3. **Java版本冲突**: 统一使用Java 21
4. **Gradle兼容性**: 严格按版本矩阵配置
5. **内存不足**: 增加JVM内存分配

### **验证检查清单**
- [ ] 所有版本号匹配兼容性矩阵
- [ ] codemagic.yaml语法正确
- [ ] LFS文件正确跟踪
- [ ] 模型文件路径匹配代码引用
- [ ] NDK自动安装脚本存在
- [ ] 内存配置充足 (8GB)

---

## 📈 **未来升级路径**

### **定期更新检查**
- Flutter稳定版本更新
- AGP/Gradle版本兼容性
- MediaPipe库更新
- 安全补丁更新

### **性能优化**
- 模型量化优化
- 构建缓存策略
- APK大小优化

---

**📝 配置文档版本**: v2024.8.31  
**✅ 验证状态**: 经过完整CI/CD测试  
**🎯 适用场景**: Flutter + MediaPipe + AI模型应用  

> 🔒 **重要**: 严格按此配置执行，避免版本冲突和构建失败