workflows:
  android-workflow:
    name: Android Build
    instance_type: mac_mini_m1
    max_build_duration: 120
    # GPT-5å»ºè®®ï¼šä¸¥æ ¼é™åˆ¶è§¦å‘æºï¼Œé˜²æ­¢æ„å»ºæ—§æäº¤
    branch_patterns:
      - pattern: main
        include: true
        source: true
    cancel_previous_builds: true  # æ–°æäº¤æ—¶è‡ªåŠ¨å–æ¶ˆæ—§æ„å»º
    cache:
      # ğŸ’£ DISABLE ALL CACHING - Force fresh build every time
      cache_paths: []
      # ç¼“å­˜å·²è¢«ç¦ç”¨ä»¥ç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç 
    environment:
      flutter: 3.19.6  # Conservative stable version for Kotlin compatibility
      xcode: latest
      cocoapods: default
      vars:
        JAVA_TOOL_OPTIONS: "-Xmx8g"
    scripts:
      - name: ğŸ” TRUTH VERIFICATION - Assert repo state & Kotlin sources
        script: |
          set -euxo pipefail
          echo "ğŸ” ===== GPT-5 DIAGNOSTIC SCRIPT ====="
          echo "CM_BRANCH=$CM_BRANCH"
          echo "CM_COMMIT=$CM_COMMIT"
          echo "Git HEAD: $(git rev-parse HEAD)"
          echo "Latest commit (on this checkout):"
          git log -1 --pretty='format:%H %ad %an %s' --date=iso

          echo "==== ğŸ•µï¸ Kotlin files that mention GemmaInference / ModelVerificationTest ===="
          grep -RIn "GemmaInference\|ModelVerificationTest" android/app/src/main/kotlin || true

          echo "==== ğŸ“ ALL MainActivity.kt files in project ===="
          find android -type f -name MainActivity.kt -print

          echo "==== ğŸ“„ Target MainActivity.kt (path + line count) ===="
          target="android/app/src/main/kotlin/com/example/legal_advisor_app/MainActivity.kt"
          ls -l "$target"
          wc -l "$target"
          echo "==== ğŸ“‹ First 200 lines of MainActivity.kt ===="
          nl -ba "$target" | sed -n '1,200p'

          echo "ğŸ›¡ï¸ ===== FUSE CHECK ====="
          lines=$(wc -l < "$target")
          if [ "$lines" -gt 20 ] || ! grep -q "class MainActivity: FlutterActivity" "$target"; then
            echo "ğŸš¨ FUSE TRIPPED: Unexpected MainActivity.kt content (lines=$lines)."
            echo "ğŸ“ Please check branch/tag/PR merge-commit and duplicate files."
            exit 1
          fi
          echo "âœ… FUSE PASSED: MainActivity.kt is minimal as expected"

      - name: Set up local properties
        script: |
          echo "flutter.sdk=$FLUTTER_ROOT" > "$FCI_BUILD_DIR/android/local.properties"

      - name: Install Android SDK components
        script: |
          echo "ğŸ“± Installing Android SDK components..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;34.0.0" "ndk;26.1.10909125" --channel=3
          echo "ğŸ”„ Updating Android SDK..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
          echo "âœ… Android SDK setup completed"

      - name: Setup Gradle properties for memory
        script: |
          mkdir -p $HOME/.gradle
          echo "org.gradle.jvmargs=-Xmx8g" > $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.configureondemand=true" >> $HOME/.gradle/gradle.properties

      - name: ğŸ’£ NUCLEAR cache clear + force latest code
        script: |
          echo "ğŸ’£ NUCLEAR OPTION: Complete cache destruction and force git sync"
          
          # 1ï¸âƒ£ å¼ºåˆ¶GitåŒæ­¥ - ç¡®ä¿æœ€æ–°ä»£ç 
          echo "ğŸ”„ Force pulling latest code..."
          git fetch origin main
          git reset --hard origin/main
          git clean -fdx
          
          # 2ï¸âƒ£ æ ¸çˆ†çº§æ¸…ç† - åˆ é™¤æ‰€æœ‰ç¼“å­˜
          echo "ğŸ’¥ Nuclear cache destruction..."
          rm -rf ~/.gradle/caches/ || true
          rm -rf ~/.android/build-cache/ || true
          rm -rf ~/.pub-cache/ || true
          rm -rf .dart_tool/ || true
          rm -rf build/ || true
          rm -rf android/.gradle/ || true
          rm -rf android/app/build/ || true
          rm -rf android/build/ || true
          
          # 3ï¸âƒ£ Flutterå®Œå…¨é‡ç½®
          echo "ğŸš€ Flutter complete reset..."
          flutter clean
          rm -f pubspec.lock
          rm -f l10n.yaml || true
          rm -rf lib/l10n/ || true
          
          # 4ï¸âƒ£ éªŒè¯MainActivity.ktæ–‡ä»¶
          echo "ğŸ” Verifying MainActivity.kt is ultra-minimal..."
          cat android/app/src/main/kotlin/com/example/legal_advisor_app/MainActivity.kt
          
          # 5ï¸âƒ£ é‡æ–°è·å–ä¾èµ–
          flutter pub get
          
          echo "âœ… NUCLEAR reset completed - fresh environment guaranteed"
          
      # SPEED OPTIMIZATION: Skip verification steps for minimal test
          
      - name: Build APK with Flutter (FAST mode)
        script: |
          echo "ğŸš€ Building APK with FAST mode..."
          echo "ğŸ“‹ Flutter version: $(flutter --version | head -1)"
          
          # ç®€åŒ–çš„å¿«é€Ÿæ„å»ºè¿‡ç¨‹
          echo "ğŸ”¨ Starting Flutter APK build..."
          flutter build apk --release
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ $? -eq 0 ]; then
            echo "âœ… APK build completed successfully!"
          else
            echo "âŒ APK build failed with exit code $?"
            exit 1
          fi
          
      - name: Verify APK created
        script: |
          echo "ğŸ” Quick APK verification..."
          APK_FILE=$(find . -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            echo "âœ… APK found: $APK_FILE"
            ls -lh "$APK_FILE"
          else
            echo "âŒ No APK file found!"
            exit 1
          fi
          
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - build/app/outputs/apk/release/*.apk
      - android/app/build/outputs/apk/release/*.apk
      - build/**/*.apk
      - android/**/*.apk
      - "**/*.apk"

    publishing:
      # android_signing:
      #   keystore: $CM_KEYSTORE
      #   keystore_password: $CM_KEYSTORE_PASSWORD
      #   key_alias: $CM_KEY_ALIAS
      #   key_password: $CM_KEY_ALIAS_PASSWORD
      
      email:
        recipients:
          - your_email@example.com
        notify:
          success: true
          failure: true