workflows:
  android-workflow:
    name: Android Build
    instance_type: mac_mini_m1
    max_build_duration: 120
    cache:
      cache_paths:
        - $HOME/.gradle/caches
        - $HOME/.android/build-cache
        - $HOME/.pub-cache
        - $FCI_BUILD_DIR/.dart_tool
      # æ€§èƒ½ä¼˜åŒ–ï¼šå¢åŠ ç¼“å­˜è·¯å¾„
    environment:
      flutter: 3.19.6  # Conservative stable version for Kotlin compatibility
      xcode: latest
      cocoapods: default
      vars:
        JAVA_TOOL_OPTIONS: "-Xmx8g"
    scripts:
      - name: Set up local properties
        script: |
          echo "flutter.sdk=$FLUTTER_ROOT" > "$FCI_BUILD_DIR/android/local.properties"

      - name: Install Android SDK components
        script: |
          echo "ğŸ“± Installing Android SDK components..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;34.0.0" "ndk;26.1.10909125" --channel=3
          echo "ğŸ”„ Updating Android SDK..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
          echo "âœ… Android SDK setup completed"

      - name: Setup Gradle properties for memory
        script: |
          mkdir -p $HOME/.gradle
          echo "org.gradle.jvmargs=-Xmx8g" > $HOME/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> $HOME/.gradle/gradle.properties
          echo "org.gradle.configureondemand=true" >> $HOME/.gradle/gradle.properties

      - name: FAST minimal package reset 
        script: |
          echo "ğŸš€ FAST minimal package reset for speed..."
          
          # åªåšå¿…è¦çš„æ¸…ç†
          flutter clean
          rm -f pubspec.lock
          
          # åˆ é™¤localizationsæ®‹ç•™æ–‡ä»¶
          rm -f l10n.yaml || true
          rm -rf .dart_tool/flutter_gen/gen_l10n/ || true
          rm -rf lib/l10n/ || true
          
          # å¿«é€Ÿè·å–ä¾èµ–ï¼ˆæç®€ä¾èµ–ï¼‰
          flutter pub get
          
          echo "âœ… FAST reset completed"
          
      # SPEED OPTIMIZATION: Skip verification steps for minimal test
          
      - name: Build APK with Flutter (FAST mode)
        script: |
          echo "ğŸš€ Building APK with FAST mode..."
          echo "ğŸ“‹ Flutter version: $(flutter --version | head -1)"
          
          # ç®€åŒ–çš„å¿«é€Ÿæ„å»ºè¿‡ç¨‹
          echo "ğŸ”¨ Starting Flutter APK build..."
          flutter build apk --release
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ $? -eq 0 ]; then
            echo "âœ… APK build completed successfully!"
          else
            echo "âŒ APK build failed with exit code $?"
            exit 1
          fi
          
      - name: Verify APK created
        script: |
          echo "ğŸ” Quick APK verification..."
          APK_FILE=$(find . -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            echo "âœ… APK found: $APK_FILE"
            ls -lh "$APK_FILE"
          else
            echo "âŒ No APK file found!"
            exit 1
          fi
          
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - build/app/outputs/apk/release/*.apk
      - android/app/build/outputs/apk/release/*.apk
      - build/**/*.apk
      - android/**/*.apk
      - "**/*.apk"

    publishing:
      # android_signing:
      #   keystore: $CM_KEYSTORE
      #   keystore_password: $CM_KEYSTORE_PASSWORD
      #   key_alias: $CM_KEY_ALIAS
      #   key_password: $CM_KEY_ALIAS_PASSWORD
      
      email:
        recipients:
          - your_email@example.com
        notify:
          success: true
          failure: true